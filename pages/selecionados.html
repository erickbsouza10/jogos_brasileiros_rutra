<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jogos Selecionados</title>

    <link rel="stylesheet" href="../css/main.css" />
</head>

<body class="bg-background min-h-screen">

    <!-- HEADER -->
    <header class="bg-surface border-b border-border sticky top-0 z-nav">
        <div class="max-w-7xl mx-auto px-sm md:px-lg py-sm flex items-center justify-between">
            <div>
                <h1 class="text-xl font-heading font-bold text-primary">
                    Jogos Selecionados
                </h1>
                <p class="text-xs text-text-secondary">
                    Revise sua agenda personalizada
                </p>
            </div>

            <div class="flex gap-2">
                <button id="voltarBtn" class="btn-secondary">
                    Voltar
                </button>
                <button id="limparBtn" class="btn-danger">
                    Limpar tudo
                </button>
            </div>
        </div>
    </header>

    <!-- CONTEÚDO -->
    <main class="max-w-7xl mx-auto px-sm md:px-lg py-lg">
        <div id="listaSelecionados" class="space-y-8"></div>

        <!-- EMPTY STATE -->
        <div id="emptyState" class="hidden text-center py-24 text-text-secondary">
            <h3 class="text-2xl font-heading font-bold mb-3">
                Nenhum jogo selecionado
            </h3>
            <p class="mb-6">
                Volte para a agenda e selecione pelo menos um jogo.
            </p>
            <button id="voltarEmptyBtn" class="btn-primary">
                Voltar para agenda
            </button>
        </div>
    </main>

    <script type="module">
        import { jogos2026 } from "../js/jogos-loader.js";
        import { getTimeById } from "../js/times-utils.js";

        const STORAGE_KEY = "agenda_jogos_selecionados";
        const container = document.getElementById("listaSelecionados");
        const emptyState = document.getElementById("emptyState");

        const dados = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};

        /* ===============================
           UTILIDADES
        ================================ */

        function parseDate(dateStr) {
            return new Date(dateStr + "T00:00:00");
        }

        function formatDateBR(date) {
            return date.toLocaleDateString("pt-BR", {
                day: "2-digit",
                month: "long",
                year: "numeric"
            });
        }

        function formatWeekDay(date) {
            return date.toLocaleDateString("pt-BR", {
                weekday: "long"
            });
        }

        function encontrarJogoPorId(id) {
            for (const campeonato of jogos2026) {
                if (Array.isArray(campeonato.jogos)) {
                    const achado = campeonato.jogos.find(j =>
                        `${j.mandante.id}-x-${j.visitante.id}-${j.data}-${j.horario}` === id
                    );
                    if (achado) return { campeonato, jogo: achado };
                }

                if (campeonato.partida) {
                    const j = campeonato.partida;
                    const pid = `${j.mandante.id}-x-${j.visitante.id}-${j.data}-${j.horario}`;
                    if (pid === id) return { campeonato, jogo: j };
                }
            }
            return null;
        }

        /* ===============================
           RENDER
        ================================ */

        const datas = Object.keys(dados).sort();

        if (datas.length === 0) {
            emptyState.classList.remove("hidden");
        } else {
            datas.forEach(data => {
                const dateObj = parseDate(data);

                const section = document.createElement("section");
                section.className = "space-y-4";

                section.innerHTML = `
          <header class="flex items-center justify-between">
            <h2  style="margin-top: 20px;" class="text-2xl font-heading font-bold text-primary capitalize">
              ${formatDateBR(dateObj)}
            </h2>
            <span class="text-sm text-text-secondary capitalize">
              ${formatWeekDay(dateObj)}
            </span>
          </header>
        `;

                const lista = document.createElement("div");
                lista.className = "space-y-3";

                dados[data].forEach(ref => {
                    const resultado = encontrarJogoPorId(ref.id);
                    if (!resultado) return;

                    const { campeonato, jogo } = resultado;
                    const mandante = getTimeById(jogo.mandante.id);
                    const visitante = getTimeById(jogo.visitante.id);

                    const card = document.createElement("article");
                    card.className = "card flex items-center justify-between";

                    card.innerHTML = `
            <div>
              <span class="text-xs font-semibold text-accent">
                ${campeonato.campeonato}
              </span>

              <div class="flex items-center gap-2 mt-1">
<img 
  src="${mandante.escudo}" 
  class="w-6 h-6" 
  onerror="this.onerror=null;this.src='https://cdn-icons-png.freepik.com/512/786/786346.png';"
/>
                <strong>${mandante.nome}</strong>
                <span class="mx-1">x</span>
                <strong>${visitante.nome}</strong>
<img 
  src="${visitante.escudo}" 
  class="w-6 h-6" 
  onerror="this.onerror=null;this.src='https://cdn-icons-png.freepik.com/512/786/786346.png';"
/>
              </div>
            </div>

            <div class="text-sm text-text-secondary">
              ${jogo.horario}
            </div>
          `;

                    lista.appendChild(card);
                });

                section.appendChild(lista);
                container.appendChild(section);
            });
        }

        /* ===============================
           AÇÕES
        ================================ */

        document.getElementById("voltarBtn").onclick = () => {
            window.history.back();
        };

        document.getElementById("voltarEmptyBtn")?.addEventListener("click", () => {
            window.location.href = "../daily_match_details.html";
        });

        document.getElementById("limparBtn").onclick = () => {
            if (confirm("Deseja remover todos os jogos selecionados?")) {
                localStorage.removeItem(STORAGE_KEY);
                window.location.reload();
            }
        };
    </script>

</body>

</html>